#! /bin/bash
installPath="INSTALLPATH"
testDir=$installPath/test_src/test+
tempDir=$installPath/temp
logDir=$installPath/log
interval=5m #INTERVAL
ftpRoot="FTPROOT"
userName="USERNAME"
timeOut="10" #Time Unit: second
SID=$RANDOM

checkRun(){
	$*
	errCode=$?
	if [ $errCode != 0 ]
	then 
		echo "[`date`][SID] Error occurred while executing command line: \"$*\". Returned with error code ($errCode)"
		exit
	fi
}

timeTransform(){
	arg=$1
	wordCount=${#arg}
	postfix=${arg:$[wordCount - 1]:1}
	arg=`echo $arg | sed "s/$postfix//g"`
	case $postfix in
	m) echo "-mmin -$arg";;
	h) echo "-mmin -$[arg * 60]";;
	d) echo "-mtime -$arg";;
	*) exit;;
	esac
}

intervalArg=`timeTransform $interval`

checkLab(){
	tiggerDir=$ftpRoot/$stuID/tigger
	empty=`checkRun ls $tiggerDir`
	changeFlag=`checkRun find $tiggerDir $intervalArg`
	#echo "find $tiggerDir $intervalArg"
	if [ "${changeFlag}x" != x -a "${empty}x" != x ]
	then 
		# Start compiling
		echo -e "  Check report for lab \"tigger\":\n" > $logDir/tigger.rep
		echo "[`date`][$SID] Found changes with file(s) from $tiggerDir, start compiling!"
		checkRun "cd $tiggerDir"
		fileList=(`ls`)
		if [ "`echo ${changeFlag[*]} | grep tar`x" != x -o ${#fileList[*]} = 1 ]
		then uncompressFlag=1
		else uncompressFlag=0
		fi
		if [ -f ./$stuID.tar -a $uncompressFlag = 1 ]
		then 
			checkRun tar -xf ./$stuID.tar
			if [ -d ./$stuID ]
			then checkRun cp -r ./$stuID/* ./
			fi
		fi

		if [ -f ./makefile -o -f ./Makefile ]
		then echo -e "cd $tiggerDir\nmake" | timeout $timeOut su - $userName > $tempDir/compile_tigger.log 2>&1 
		elif [ -f ./compile ]
		then 
			chmod +x ./compile
			echo -e "cd $tiggerDir\n./compile" | timeout $timeOut su - $userName > $tempDir/compile_tigger.log 2>&1
		else 
			mailFormat=NO_COMPILE_METHOD
			echo "Error: Cann't find an appropriate method to compile your source file!" >> $logDir/tigger.rep
			echo "[`date`][$SID] No method found to compile source file while testing student[$stuID]!"
			return
		fi
		errCode=$?
		if [ $errCode = 124 ]
		then 
			mailFormat=COMPILE_TIMEOUT
			echo "Error: Timelimit exceeded while compiling your source file!" >> $logDir/tigger.rep
			echo "[`date`][$SID] Timeout while compiling for student[$stuID]"
			return
		elif [ $errCode != 0 ]
		then 
			mailFormat=COMPILE_ERROR
			echo "Error: We have encountered with some problems compiling your source files! You may find more details below or in the file attached with this email!" >> $logDir/tigger.rep
			echo "[`date`][$SID] Error(s) occurred with compiling for student[$stuID]"
			return
		fi
		checkRun cp $tempDir/compile_tigger.log ./

		# Start test
		if [ ! -f ./tigger ]
		then 
			mailFormat=NO_BINARY_FILE
			echo "Error: Can not locate binary file \"tigger\" for compilation!" >> $logDir/tigger.rep
			echo "[`date`][$SID] Cannot locate binary file compiled with compiling method for student[$stuID]"
			return
		fi
		for file in $testDir/*.c
		do
			testName=(`basename $file | sed 's/\./ /g'`)
			#if [ $testName = 25_bubblesort ]
			#then continue
			#fi
			# Use tigger compile C file
			timeout $timeOut ./tigger < $file > $tempDir/${testName}_$SID.t 2> $tempDir/compile_c2t.log
			errCode=$?
			if [ $errCode = 124 ]
			then 
				mailFormat=RUN_TIMEOUT
				echo "Error: Timelimit exceeded while compile MiniC file \"${testName}.c\" to tigger with your executable file!" >> $logDir/tigger.rep
				echo "[`date`][$SID] Timelimit exceeded while running tigger for \"${testName}.c\" with student[$stuID]'s tigger"
				return
			elif [ $errCode != 0 ]
			then
				mailFormat=RUNTIME_ERROR
				#echo -e "\nRunning result may hold some useful information:\n" >> $tempDir/compile_c2e.log
				#cat $tempDir/${testName}_$SID.e >> $tempDir/compile_c2e.log
				echo "Error: Runtime error occurred while compiling MiniC file \"${testName}.c\" to tigger with your excutable file! You may find more details below or in the file attached with this email." >> $logDir/tigger.rep
				echo "[`date`][$SID] Runtime error occurred while running tigger for \"${testName}.c\" with student[$stuID]'s tigger"
				return
			fi
			checkRun cp $tempDir/compile_c2t.log ./

			# Simulating tigger file
			if [ -f $testDir/$testName.input ]
			then timeout $timeOut sudo $installPath/bin/Tigger $tempDir/${testName}_$SID.t < $testDir/$testName.input > $tempDir/${testName}_$SID.result 2> $tempDir/runtime_tigger.log
			else timeout $timeOut sudo $installPath/bin/Tigger $tempDir/${testName}_$SID.t > $tempDir/${testName}_$SID.result 2> $tempDir/runtime_tigger.log
			fi
			errCode=$?
			if [ $errCode = 124 ]
			then
				mailFormat=SIM_TIMEOUT
				echo "Error: Timelimit exceeded while simulating \"${testName}.c\" with the tigger code generated!" >> $logDir/tigger.rep
				echo "[`date`][$SID] Timelimit exceeded while simulating \"${testName}.c\" for student[$stuID]"
				return
			else echo $errCode >> $tempDir/${testName}_$SID.result
			fi
			checkRun cp $tempDir/runtime_tigger.log ./
			
			# Comparing simulation result
			diffInfo=`diff $tempDir/${testName}_$SID.result $testDir/$testName.output`
			if [ "${diffInfo}x" != x ]
			then 
				mailFormat=SIM_WRONG_RESULT
				echo "Error: Simulation result mismatch with \"${testName}.output\"" >> $logDir/tigger.rep
				echo "[`date`][$SID] Simulation result mismatch for student[$stuID] with \"${testName}.output\""
				return
			fi
		done
		echo "Congratulations! You have passed the test for lab-tigger!" >> $logDir/tigger.rep
		mailFormat=TEST_PASS
	else mailFormat=0
	fi
}

if [ ! -d $installPath ]
then 
	echo "<Error> Minic Checker root directory not found!"
	exit
fi

while [ 1 ]
do
	echo "[`date`][$SID] Start checking homeworks"
	stuList=`checkRun "cat $installPath/config/students.list"`
	for stuID in $stuList
	do
		checkLab
		if [ $mailFormat != 0 ]
		then 
			echo -e "\n  This report was automatically generated by Minic Checker at [`date`]">> $logDir/tigger.rep
			echo "[`date`][$SID] Check finished. Get status [$mailFormat] for student [$stuID]! Sending email..."
			$installPath/scripts/send_mail $stuID@pku.edu.cn -f $installPath/config/minic_checker.mf -t CHECK TIGGER $mailFormat
		fi
	done
	sleep $interval
done
